#!/bin/sh

echo "Running pre-commit checks..."

# =============================================================================
# BACKEND CHECKS (Python) - Run first, before frontend
# =============================================================================

# Check if there are staged Python files in apps/backend
if git diff --cached --name-only | grep -q "^apps/backend/.*\.py$"; then
  echo "Python changes detected, running backend checks..."

  # Run ruff linting
  echo "Running ruff lint..."
  ruff check apps/backend/ --fix
  if [ $? -ne 0 ]; then
    echo "Ruff lint failed. Please fix Python linting errors before committing."
    exit 1
  fi

  # Run ruff format check
  echo "Running ruff format check..."
  ruff format apps/backend/ --check
  if [ $? -ne 0 ]; then
    echo "Ruff format check failed. Run 'ruff format apps/backend/' to fix."
    exit 1
  fi

  # Run pytest (skip slow/integration tests and Windows-incompatible tests for pre-commit speed)
  echo "Running Python tests..."
  cd apps/backend
  # Tests to skip: graphiti (external deps), merge_file_tracker/service_orchestrator/worktree/workspace (Windows path/git issues)
  IGNORE_TESTS="--ignore=../../tests/test_graphiti.py --ignore=../../tests/test_merge_file_tracker.py --ignore=../../tests/test_service_orchestrator.py --ignore=../../tests/test_worktree.py --ignore=../../tests/test_workspace.py"
  if [ -d ".venv" ]; then
    # Use venv if it exists
    if [ -f ".venv/bin/pytest" ]; then
      PYTHONPATH=. .venv/bin/pytest ../../tests/ -v --tb=short -x -m "not slow and not integration" $IGNORE_TESTS
    elif [ -f ".venv/Scripts/pytest.exe" ]; then
      # Windows
      PYTHONPATH=. .venv/Scripts/pytest.exe ../../tests/ -v --tb=short -x -m "not slow and not integration" $IGNORE_TESTS
    else
      PYTHONPATH=. python -m pytest ../../tests/ -v --tb=short -x -m "not slow and not integration" $IGNORE_TESTS
    fi
  else
    PYTHONPATH=. python -m pytest ../../tests/ -v --tb=short -x -m "not slow and not integration" $IGNORE_TESTS
  fi
  if [ $? -ne 0 ]; then
    echo "Python tests failed. Please fix failing tests before committing."
    exit 1
  fi
  cd ../..
  
  echo "Backend checks passed!"
fi

# =============================================================================
# FRONTEND CHECKS (TypeScript/React)
# =============================================================================

# Check if there are staged files in apps/frontend
if git diff --cached --name-only | grep -q "^apps/frontend/"; then
  echo "Frontend changes detected, running frontend checks..."
  cd apps/frontend
  
  # Run lint-staged (handles staged .ts/.tsx files)
  npm exec lint-staged
  
  # Run TypeScript type check
  echo "Running type check..."
  npm run typecheck
  if [ $? -ne 0 ]; then
    echo "Type check failed. Please fix TypeScript errors before committing."
    exit 1
  fi
  
  # Run linting
  echo "Running lint..."
  npm run lint
  if [ $? -ne 0 ]; then
    echo "Lint failed. Run 'npm run lint:fix' to auto-fix issues."
    exit 1
  fi
  
  # Check for vulnerabilities (only high severity)
  echo "Checking for vulnerabilities..."
  npm audit --audit-level=high
  if [ $? -ne 0 ]; then
    echo "High severity vulnerabilities found. Run 'npm audit fix' to resolve."
    exit 1
  fi
  
  cd ../..
  echo "Frontend checks passed!"
fi

echo "All pre-commit checks passed!"
